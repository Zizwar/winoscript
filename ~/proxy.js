// -----------------------------------------------------------------------------
// ุงูููู: package.json
// -----------------------------------------------------------------------------
// ููุญุตูู ุนูู ููุชุจุฉ axiosุ ูุฌุจ ุฃู ูููู ูุฐุง ุงูููู ููุฌูุฏูุง ูู ูุฌูุฏู
// ุซู ูู ุจุชุดุบูู ุงูุฃูุฑ: npm install
// {
//   "name": "wino-node-demo",
//   "version": "1.0.0",
//   "description": "Simplified WinoScript for Node.js",
//   "main": "index.js",
//   "type": "module", // ููู ุฌุฏูุง ูุงุณุชุฎุฏุงู import/export
//   "scripts": {
//     "start": "node index.js"
//   },
//   "dependencies": {
//     "axios": "^1.7.2"
//   }
// }

// -----------------------------------------------------------------------------
// ุงูููู: index.js
// -----------------------------------------------------------------------------
// ูู ุจุฅูุดุงุก ูุฐุง ุงูููู ูุดุบู ุงูุฃูุฑ: node index.js
import axios from 'axios';

// ูุฐุง ูู "ุงูุนูู" ุงูุฐู ุณูุญุชูุธ ุจุงูุฏูุงู ุงูุชู ูุชู ุฅูุดุงุคูุง
const generatedFunctions = new Map();

/**
 * ูุญุงูู ูุฐุง ุงูุฌุฒุก ุทูุจูุง ููุฐูุงุก ุงูุงุตุทูุงุนู. ูู ุงููุงูุนุ ููููู ููุง
 * ุงุณุชุฏุนุงุก OpenAI ุฃู ุฃู ูููุฐุฌ ูุบูู ุขุฎุฑ.
 * @param {string} path - ุงููุณุงุฑ ุงูุฐู ููุซู ููุฉ ุงููุณุชุฎุฏู.
 * @returns {string | null} - ุณูุณูุฉ ูุตูุฉ ุชุญุชูู ุนูู ููุฏ ุงูุฏุงูุฉ ุงููุฑุงุฏ ุฅูุดุงุคูุง.
 */
function simulateAICall(path) {
    console.log(`\x1b[35m[AI SIMULATOR] ๐ง ุชูููุช ุทูุจูุง ูุฅูุดุงุก ุฏุงูุฉ ูููุณุงุฑ: '${path}'\x1b[0m`);

    // ุจูุงุกู ุนูู ุงููุณุงุฑุ ููุฑุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูููุฏ ุงูููุงุณุจ
    if (path === 'ai.get.binance.price') {
        console.log(`\x1b[35m[AI SIMULATOR] โ ูููุช ุงูููุฉ. ุณุฃููู ุจุฅูุดุงุก ููุฏ ูุณุชุฎุฏู Binance API.\x1b[0m`);
        // ุงูุฐูุงุก ุงูุงุตุทูุงุนู "ููุชุจ" ูุฐุง ุงูููุฏ ููุนูุฏู ููุต
        return `
            // This function was dynamically generated by a simulated AI.
            // It takes one argument: the symbol.
            async function getPrice(symbol) {
                // ุงูุชุฃูุฏ ูู ุฃู ุงูุฑูุฒ ุจุงูู uppercase
                const formattedSymbol = symbol.toUpperCase();
                const url = \`https://api.binance.com/api/v3/ticker/price?symbol=\${formattedSymbol}\`;
                
                console.log(\`   [Generated Function] ๐ ุทูุจ ุงูุณุนุฑ ูู \${formattedSymbol} ูู ุจุงููุงูุต...\`);
                
                try {
                    const response = await axios.get(url);
                    return {
                        symbol: response.data.symbol,
                        price: parseFloat(response.data.price),
                        retrievedAt: new Date().toISOString()
                    };
                } catch (error) {
                    console.error(\`   [Generated Function] โ ุฎุทุฃ ูู ุฌูุจ ุงูุณุนุฑ ูู \${formattedSymbol}:\`, error.response ? error.response.data.msg : error.message);
                    return { error: 'Failed to fetch price.', details: error.response ? error.response.data.msg : error.message };
                }
            }
        `;
    }

    // ุฅุฐุง ูู ูุชุนุฑู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุนูู ุงููุณุงุฑ
    console.log(`\x1b[35m[AI SIMULATOR] โ ูุง ุฃุนุฑู ููู ุฃูุดุฆ ุฏุงูุฉ ููุฐุง ุงููุณุงุฑ.\x1b[0m`);
    return null;
}


/**
 * ูุฐุง ูู ุงูู Proxy ุงูุณุญุฑู ุงูุฐู ูุนุชุฑุถ ุงุณุชุฏุนุงุก ุงูุฏูุงู ุบูุฑ ุงูููุฌูุฏุฉ.
 * ุฅูู ูุณุชุฎุฏู ุชูููุฉ ุงูู Chaining (ุงูุณูุงุณู).
 * @param {string[]} path - ุงููุณุงุฑ ุงูุฐู ูุชู ุจูุงุคูุ ูุซู ['ai', 'get']
 */
function createChainableProxy(path = []) {
    // ุงูู Proxy ูู ูุงุฆู ูุงุฑุบ ูููู ุงุณุชุฏุนุงุคู ูุฏุงูุฉ
    const handler = () => {};

    return new Proxy(handler, {
        // ูุชู ุชูุนูู ูุฐุง ุงูุฌุฒุก ุนูุฏ ุงููุตูู ุฅูู ุฎุงุตูุฉุ ูุซู wino.ai
        get(target, prop) {
            // ูุถูู ุงูุฎุงุตูุฉ ุงูุฌุฏูุฏุฉ ูููุณุงุฑ ููุฑุฌุน Proxy ุฌุฏูุฏ
            return createChainableProxy([...path, prop]);
        },

        // ูุชู ุชูุนูู ูุฐุง ุงูุฌุฒุก ุนูุฏ ุงุณุชุฏุนุงุก ุงููุงุฆู ูุฏุงูุฉุ ูุซู price(...)
        async apply(target, thisArg, args) {
            const functionPath = path.join('.');
            console.log(`\n\x1b[36m[WINO CORE] โก๏ธ ุชู ุงุณุชุฏุนุงุก ุงููุณุงุฑ ุงูุฏููุงูููู: '${functionPath}'\x1b[0m`);

            // 1. ุงูุจุญุซ ูู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ (Cache) ุฃููุงู
            if (generatedFunctions.has(functionPath)) {
                console.log(`\x1b[32m[WINO CORE] โ ุงูุฏุงูุฉ ููุฌูุฏุฉ ูู ุงูุฐุงูุฑุฉ! ุณูุชู ุงุณุชุฎุฏุงููุง ูุจุงุดุฑุฉ.\x1b[0m`);
                const func = generatedFunctions.get(functionPath);
                // ุชูููุฐ ุงูุฏุงูุฉ ุงููุฎุฒูุฉ
                return func(...args);
            }

            // 2. ุฅุฐุง ูู ุชูู ููุฌูุฏุฉุ ุงุทูุจ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุฅูุดุงุฆูุง
            console.log(`\x1b[33m[WINO CORE] โ ุงูุฏุงูุฉ ุบูุฑ ููุฌูุฏุฉ. ุณูุชู ุทูุจูุง ูู ูุญุงูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู...\x1b[0m`);
            const functionCodeString = simulateAICall(functionPath);

            if (!functionCodeString) {
                const errorMsg = `[WINO CORE] โ ูุดู ูู ุฅูุดุงุก ุงูุฏุงูุฉ. ุงููุณุงุฑ '${functionPath}' ุบูุฑ ูุนุฑูู.`;
                console.error(`\x1b[31m${errorMsg}\x1b[0m`);
                return { error: errorMsg };
            }

            // 3. ุฅูุดุงุก ุฏุงูุฉ ุญููููุฉ ูู ุงูููุฏ ุงููุตู ูุชุฎุฒูููุง
            // "eval" ุขูู ููุง ูุฃููุง ูุซู ุจูุตุฏุฑ ุงูููุฏ (ูุญุงูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู)
            const newFunc = eval(`(${functionCodeString})`);
            generatedFunctions.set(functionPath, newFunc);
            console.log(`\x1b[32m[WINO CORE] ๐๏ธ ุชู ุฅูุดุงุก ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ูุชุฎุฒูููุง ุจูุฌุงุญ.\x1b[0m`);

            // 4. ุชูููุฐ ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ูุฃูู ูุฑุฉ
            return newFunc(...args);
        }
    });
}


// --- ููุทุฉ ุงูุจุฏุงูุฉ ---
const wino = createChainableProxy();

// ุฏุงูุฉ ุฑุฆูุณูุฉ ูุชุดุบูู ุงููุซุงู
async function main() {
    console.log("--- ๐ ุงูุงุณุชุฏุนุงุก ุงูุฃูู: ุณูุชู ุฅูุดุงุก ุงูุฏุงูุฉ ูู ุงูุตูุฑ ---");
    const btcResult = await wino.ai.get.binance.price("BTCUSDT");
    console.log("โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:", btcResult, "\n");

    console.log("--- โก๏ธ ุงูุงุณุชุฏุนุงุก ุงูุซุงูู: ุณูุชู ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุฎุฒูุฉ (ุฃุณุฑุน) ---");
    const ethResult = await wino.ai.get.binance.price("ETHUSDT");
    console.log("โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:", ethResult, "\n");

    console.log("--- ๐ ุงูุงุณุชุฏุนุงุก ุงูุซุงูุซ: ุชุฃููุฏ ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ---");
    const xrpResult = await wino.ai.get.binance.price("XRPUSDT");
    console.log("โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:", xrpResult, "\n");
    
    console.log("--- โ ุงูุงุณุชุฏุนุงุก ุงูุฑุงุจุน: ุชุฌุฑุจุฉ ูุณุงุฑ ุบูุฑ ูุนุฑูู ---");
    const unknownResult = await wino.ai.calculate.fibonacci(10);
    console.log("โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:", unknownResult);
}

// ุชุดุบูู ุงูุจุฑูุงูุฌ
main();

